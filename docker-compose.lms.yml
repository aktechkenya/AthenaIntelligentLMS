# AthenaLMS — New Services Overlay
# Usage: docker compose -f ../AthenaCreditScore/docker-compose.yml -f docker-compose.lms.yml up
#
# Build context is always the AthenaIntelligentLMS root so shared/ lib is accessible.
# Each service Dockerfile copies shared/athena-lms-common and installs it before building.

version: "3.9"

networks:
  athena-net:
    external: true
    name: athenacreditscore_athena-net

volumes:
  accounts_data:
  products_data:
  loans_data:
  payments_data:
  accounting_data:
  float_data:
  collections_data:
  compliance_data:
  reporting_data:
  scoring_data:
  loki_data:

x-lms-common: &lms-common
  restart: unless-stopped
  networks:
    - athena-net

x-lms-env: &lms-env
  SPRING_RABBITMQ_HOST: rabbitmq
  SPRING_RABBITMQ_USERNAME: ${RABBITMQ_USER:-athena}
  SPRING_RABBITMQ_PASSWORD: ${RABBITMQ_PASS:-athena_secret}
  JWT_SECRET: ${JWT_SECRET}
  EUREKA_URI: http://discovery-server:8761/eureka/
  APP_ENV: production

services:

  # ─── Init: create all LMS databases ─────────────────────────────────────────
  lms-db-init:
    image: postgres:16-alpine
    container_name: lms-db-init
    environment:
      PGPASSWORD: ${POSTGRES_PASSWORD:-athena_secret}
    volumes:
      - /home/adira/AthenaIntelligentLMS/scripts/init-lms-databases.sql:/init-lms-databases.sql:ro
    command: >
      sh -c "psql -h postgres -U ${POSTGRES_USER:-athena} -d postgres -f /init-lms-databases.sql || true"
    networks:
      - athena-net
    depends_on:
      postgres:
        condition: service_healthy

  # ─── Account Service (port 8086) ─────────────────────────────────────────────
  account-service:
    <<: *lms-common
    build:
      context: /home/adira/AthenaIntelligentLMS
      dockerfile: account-service/Dockerfile
    container_name: lms-account-service
    environment:
      <<: *lms-env
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/athena_accounts
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-athena}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-athena_secret}
    ports:
      - "8086:8086"
    depends_on:
      lms-db-init:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8086/actuator/health | grep -q UP || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5

  # ─── Product Service (port 8087) ─────────────────────────────────────────────
  product-service:
    <<: *lms-common
    build:
      context: /home/adira/AthenaIntelligentLMS
      dockerfile: product-service/Dockerfile
    container_name: lms-product-service
    environment:
      <<: *lms-env
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/athena_products
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-athena}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-athena_secret}
    ports:
      - "8087:8087"
    depends_on:
      lms-db-init:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8087/actuator/health | grep -q UP || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5

  # ─── Loan Origination Service (port 8088) ────────────────────────────────────
  loan-origination-service:
    <<: *lms-common
    build:
      context: /home/adira/AthenaIntelligentLMS
      dockerfile: loan-origination-service/Dockerfile
    container_name: lms-loan-origination-service
    environment:
      <<: *lms-env
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/athena_loans
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-athena}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-athena_secret}
    ports:
      - "8088:8088"
    depends_on:
      lms-db-init:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8088/actuator/health | grep -q UP || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5

  # ─── Loan Management Service (port 8089) ─────────────────────────────────────
  loan-management-service:
    <<: *lms-common
    build:
      context: /home/adira/AthenaIntelligentLMS
      dockerfile: loan-management-service/Dockerfile
    container_name: lms-loan-management-service
    environment:
      <<: *lms-env
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/athena_loans
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-athena}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-athena_secret}
    ports:
      - "8089:8089"
    depends_on:
      lms-db-init:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
      loan-origination-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8089/actuator/health | grep -q UP || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5

  # ─── Payment Service (port 8090) ─────────────────────────────────────────────
  payment-service:
    <<: *lms-common
    build:
      context: /home/adira/AthenaIntelligentLMS
      dockerfile: payment-service/Dockerfile
    container_name: lms-payment-service
    environment:
      <<: *lms-env
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/athena_payments
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-athena}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-athena_secret}
    ports:
      - "8090:8090"
    depends_on:
      lms-db-init:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8090/actuator/health | grep -q UP || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5

  # ─── Accounting Service (port 8091) ──────────────────────────────────────────
  accounting-service:
    <<: *lms-common
    build:
      context: /home/adira/AthenaIntelligentLMS
      dockerfile: accounting-service/Dockerfile
    container_name: lms-accounting-service
    environment:
      <<: *lms-env
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/athena_accounting
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-athena}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-athena_secret}
    ports:
      - "8091:8091"
    depends_on:
      lms-db-init:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
      payment-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8091/actuator/health | grep -q UP || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5

  # ─── Float Service (port 8092) ───────────────────────────────────────────────
  float-service:
    <<: *lms-common
    build:
      context: /home/adira/AthenaIntelligentLMS
      dockerfile: float-service/Dockerfile
    container_name: lms-float-service
    environment:
      <<: *lms-env
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/athena_float
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-athena}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-athena_secret}
    ports:
      - "8092:8092"
    depends_on:
      lms-db-init:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
      payment-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8092/actuator/health | grep -q UP || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5

  # ─── Collections Service (port 8093) ─────────────────────────────────────────
  collections-service:
    <<: *lms-common
    build:
      context: /home/adira/AthenaIntelligentLMS
      dockerfile: collections-service/Dockerfile
    container_name: lms-collections-service
    environment:
      <<: *lms-env
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/athena_collections
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-athena}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-athena_secret}
    ports:
      - "8093:8093"
    depends_on:
      lms-db-init:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
      loan-management-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8093/actuator/health | grep -q UP || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5

  # ─── Compliance Service (port 8094) ──────────────────────────────────────────
  compliance-service:
    <<: *lms-common
    build:
      context: /home/adira/AthenaIntelligentLMS
      dockerfile: compliance-service/Dockerfile
    container_name: lms-compliance-service
    environment:
      <<: *lms-env
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/athena_compliance
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-athena}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-athena_secret}
    ports:
      - "8094:8094"
    depends_on:
      lms-db-init:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8094/actuator/health | grep -q UP || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5

  # ─── Reporting Service (port 8095) ───────────────────────────────────────────
  reporting-service:
    <<: *lms-common
    build:
      context: /home/adira/AthenaIntelligentLMS
      dockerfile: reporting-service/Dockerfile
    container_name: lms-reporting-service
    environment:
      <<: *lms-env
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/athena_reporting
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-athena}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-athena_secret}
    ports:
      - "8095:8095"
    depends_on:
      lms-db-init:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8095/actuator/health | grep -q UP || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5

  # ─── AI Scoring Service (port 8096) ──────────────────────────────────────────
  # Bridge adapter: calls existing AthenaCreditScore Python service (athena-python-service:8001)
  ai-scoring-service:
    <<: *lms-common
    build:
      context: /home/adira/AthenaIntelligentLMS
      dockerfile: ai-scoring-service/Dockerfile
    container_name: lms-ai-scoring-service
    environment:
      <<: *lms-env
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/athena_scoring
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-athena}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-athena_secret}
      ATHENA_SCORING_URL: ${ATHENA_SCORING_URL:-http://athena-python-service:8001}
    ports:
      - "8096:8096"
    depends_on:
      lms-db-init:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
      loan-origination-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8096/actuator/health | grep -q UP || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5

  # ─── LMS Portal UI (port 3000) ───────────────────────────────────────────────
  lms-portal-ui:
    <<: *lms-common
    build:
      context: /home/adira/AthenaIntelligentLMS/lms-portal-ui
      dockerfile: Dockerfile
    container_name: lms-portal-ui
    image: athenacreditscore-lms-portal-ui:latest
    ports:
      - "3001:3000"
    depends_on:
      account-service:
        condition: service_healthy
      product-service:
        condition: service_healthy
      loan-origination-service:
        condition: service_healthy
      loan-management-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/ | grep -q 'html' || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5


  # ─── Loki (log aggregation) ───────────────────────────────────────────────
  loki:
    image: grafana/loki:2.9.4
    container_name: lms-loki
    restart: unless-stopped
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - loki_data:/loki
    networks:
      - athena-net

  # ─── Promtail (log shipper: Docker logs → Loki) ───────────────────────────
  promtail:
    image: grafana/promtail:2.9.4
    container_name: lms-promtail
    restart: unless-stopped
    volumes:
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - /home/adira/AthenaIntelligentLMS/monitoring/promtail:/etc/promtail:ro
    command: -config.file=/etc/promtail/config.yml
    networks:
      - athena-net
    depends_on:
      - loki
